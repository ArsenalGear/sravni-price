##Сайт сравнения цен в различных магазинах на базе фреймворка laravel.
##Важно!
Сайт использует систему поддоменов для различных городов.
В связи с этим все поддомены сервера должны вести на основной ip.
В процессе разработки поддерживались миграции и seed's - следует учитывать при дальнейшей разработке и по возможности поддерживать

##Установка и настройка
Есть два варианта разворачивания сайта на сервере: с установкой и настройкой всех необходимых для работы сайта приложений, сервисов и расширений и через docker.
Для постоянной работы сайта предпочтительнее первый способ, для разработки и тестирования - второй. Второй гораздо проще - он не требует ручной установки сервисов и расширений, нужны только nginx и docker

## Способ 1 (для продакшн)

Большую часть времени займёт установка и правильная настройка приложений и расширений, также возможны конфликты с уже установленными расширениями и версиями приложений:
#### На сервере должны быть установлены:
- centos 7
- nginx 1.14.2 или выше
- mysql 5.7
- supervisord
- composer
- php 7.2
- расширения zmq для php 7.2 (apt-get install -y -qq libzmq3-dev; pecl install zmq-beta)
- расширение exif для php 7.2
- расширение gd для php 7.2
- git
- zip/unzip
- возможно, в процессе запуска сайта потребуются установить другие расширения, необходимые для работы отдельных плагинов и модулей
- phpmyadmin
- все расширения должны быть подключены в php.ini
- redis 4.0
- возможен конфликт с ispmanager из-за разных версий php и расширений для них, поэтому желательно отказаться от каких-либо панелей управления

####Процесс настройки и запуска:
- прописать в nginx стандартные настройки для laravel
- настроить редирект с основного домена на поддомен moscow.yoursite.ru. Также все поддомены сервера должны вести на один ip
- клонировать ветку репозитория git с сайта
- дать права 777 для папки storage и всех внутренних (chmod 777 -R storage)
- скопировать файл .env.example и переименовать в .env в корне сайта
- сгенерировать уникальный ключ приложения для laravel командой ```php artisan key:generate```
- создать базу данных для сайта (utf-8 general ci) и импортировать дамп базы (например, через phpmyadmin)
- прописать необходимые настройки в .env файле, такие как доступы к БД, порты, название приложения, smtp
- если порты, указанные в .env, закрыты - открыть
- установить плагины командой ```composer install``` (установятся автоматически)
- в настройках supervisord прописать запуск команд:
```php
    php artisan socketpush:serve для запуска пушера (для модуля парсинга)
    php artisan queue:work database --sleep=3 --tries=1 --timeout=1800 для запуска очередей (для модуля парсинга)
```
- запустить процессы supervisord'а
- проверить правильную работу сайта
- после загрузки изменений из гита необходимо перезагружать процессы supervisord'а и очищать кэш laravel (команды для очистки кэша - ```php artisan cache:clear``` и ```php artisan view:clear```)

## Способ 2 (для разработки и тестирования)

Docker создаёт собственное изолированное окружение для сайта, что предотвращает конфликты с внешними приложениями, расширениями и т.д. Также docker частично автоматизирует установку необходимых для сайта приложений и расширений.
#### На сервере должны быть установлены
- centos 7
- nginx 1.14.2 или выше
- docker 18.09.4 или выше
- docker-compose 1.24.0 или выше
- git

#### Процесс настройки
- клонировать ветку репозитория git с сайта
- скопировать файл .env.example и переименовать в .env в корне сайта
- прописать необходимые настройки в .env файле, такие как доступы к БД, порты, название приложения, smtp
- выполнить sudo docker-compose build для автоматической установки необходимых для работы сайта приложений и расширений, дождаться окончания установки
- проверить и при необходимости настроить порты в файле docker-compose.yml - порты докера (указаны после двоеточия) должны совпадать с указанными в .env файле; внешние порты (указаны до двоеточия) должны быть открыты на сервере.
- выполнить ```sudo docker-compose up -d``` для запуска докера, дождаться окончания установки необходимых образов
- дать права 777 для папки storage и всех внутренних (```sudo docker-compose exec -d app chmod 777 -R storage```)
- выполнить установку дополнительных плагинов sudo docker-compose exec app composer install
- настроить редирект с основного домена на поддомен moscow.yoursite.ru. Также все поддомены сервера должны вести на один ip
- перейти по настроенному в nginx адресу сайта, добавив в конце внешний порт, указаный в docker-compose.yml в настройках образа phpmyadmin - по умолчанию 8769 
    например: http://moscow.localhost:8769
- создать базу данных для сайта (utf-8 general ci) и импортировать дамп базы


#### Запуск
для запуска сайта необходимо выполнить следующие команды
```php
    sudo docker-compose exec -d app php artisan serve --host=0.0.0.0 для запуска сайта
    sudo docker-compose exec app php artisan cahce:clear для очистки кеша
    sudo docker-compose exec -d app php artisan socketpush:serve для запуска пушера (для модуля парсинга)
    sudo docker-compose exec -d app php artisan queue:work database --sleep=3 --tries=1 --timeout=1800 для запуска очередей (для модуля парсинга)
```
- проверить правильную работу сайта
- после загрузки изменений из гита необходимо перезагружать docker и очищать кэш laravel
```php
    sudo docker-compose down (отключает докер)
    sudo docker-compose up -d
    sudo docker-compose exec app php artisan cache:clear (очистить основной кэш laravel)
    sudo docker-compose exec app php artisan view:clear (очистить кэш представлений laravel)
    sudo docker-compose exec -d app php artisan serve --host=0.0.0.0 для запуска сайта
    sudo docker-compose exec -d app php artisan socketpush:serve для запуска пушера (для модуля парсинга)
    sudo docker-compose exec -d app php artisan queue:work database --sleep=3 --tries=1 --timeout=1800 для запуска очередей (для модуля парсинга)
```
- проверить правильную работу сайта

## Дополнительная информация (для разработчиков)

При запуске с чистой базой данных без загрузки sql дампа (в процессе разработки могут отсутствовать некоторые необходимые seed'еры, поэтому работоспособность не гарантируется - запись информационная, для разработчиков) дополнительно выполняются команды:
```php
php artisan voyager:install (сам применит необходимые миграции и seed'еры - кроме стандартных ещё и те, которые нужны для админки voyager)
php artisan db:seed --class=ContentSeeder (наполнение тестовым контентом)
php artisan fixtree:fix (первоначальный пересчёт отношений категорий. Если не выполнить, внутренние ссылки будут работать неправильно)
```

Специальные команды:
```php
php artisan parse:cleardb - удаляет товары, категории, бренды, фильтры и связи между ними, таблицу очередей для запуска "чистого" парсинга
php artisan parse:csv --shop_id=1 --sales=false - запускает парсер (для нормальной работы требует запушеного пушера и очередей). Обязательный параметр shop_id - id магазина, для которого буде запущен парсер.
Параметр --sales не обязателен, по умолчанию false. Опция --sales=true запускает парсинг файла со скидками.
``` 
В файле app/Console/Commands/ParseCsv.php можно выставить настройки парсинга (в основном используются для тестирования. Полная работоспособность всех функий не гарантируется):
```php
images_only_hrefs (true или false) - скачивать изображения при парсинге или заносить в базу данных только ссылки из csv
test_categories_mapping (true или false) - таблица соответствий категорий заполняется рандомно, раскидывая их по первым 12 категориям 
only_n_products (true или false) - парсить только n первых товара
count_of_parsed_products (число) - кол-во товаров, которое необходимо спарсить (работает при only_n_products=true)
fake_csv (true или false) - не загружать csv файл, а использовать заранее скаченный
fake_csv_name (название файла с расширением) - используется для опции fake_csv
logs (true или false) - включить/выключить логирование (использовать для тестов)
```
### Особые настройки в .env
```APP_URL``` - url приложения (например, http://localhost:8085)<br>
```APP_HOSTNAME``` - основной домен (без поддоменов)<br>
```APP_PUSH_PORT``` - порт для пушера (используется для рассылки процента парсинга и сопутствующих сообщений)<br>
```APP_ZMQ_PORT``` - порт zmq (используется для рассылки процента парсинга и сопутствующих сообщений)<br>
```MAIL_USERNAME``` - почта (gmail), использующаяся для рассылки писем с сайта. В настройках gmail необходимо включить доступ для небезопасных приложений, или использовать ключ приложения<br>
```MAIL_PASSWORD``` - пароль от почты, использующаяся для рассылки писем с сайта<br>
```APP_DEBUG=false``` - для production должно быть закомментировано (символ # в начале), отвечает за детальный вывод ошибок laravel (на production должно быть просто "Ошибка сервера" без вывода детальной информации для разработчиков - она попадает в логи)
####Настройки кеширования
Кеширование на сайте производится с помощью redis. Время кеширования указывается в секундах (число 3600 соответствуют часу)<br>
```CACHE_DRIVER=redis``` - использовать редис<br>
```REDIS_PRODUCTS_CACHE_TIME=3600``` - время хранения кеша просмотров. Кол-во просмотров обновляется в базе после того, как кеш станет некатуальным (в данном случае, при просмотре страницы товара через час)<br>
```REDIS_ONE_PRODUCT_CACHE_TIME=3600``` - время хранения кеша для данных страницы товара<br>
```REDIS_PRODUCT_ARTICLES_CACHE_TIME=3600``` - время хранения кеша страницы списка обзоров товаров<br>
```REDIS_PRODUCT_ONE_ARTICLE_CACHE_TIME``` - время хранения кеша страницы одного обзора товара.<br>
```REDIS_HOME_PAGE_CACHE=3600``` - время хранения кеша главной страницы<br>
Для применения настроек при изменении данных параметров необходимо очистить кеш командой ```php artisan cache:clear``` (или ```sudo docker-compose exec app php artisan cache:clear``` при использовании docker)<br>
### Подгрузка видео с youtube
Ключ API для подгрузки видео на страницу товара прописывается в public/js/common-good.js  (найти комментарий "Видео с youtube - первое из поиска по названию товара", вставить как значение ключа 'key')

###Robots.txt
Лежит в папке public/robots.txt - на production необходимо открыть доступ для робота поисковых систем

## License

The Laravel framework is open-source software licensed under the [MIT license](https://opensource.org/licenses/MIT).
